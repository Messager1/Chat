<html lang="en"><head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CompSci Chat</title>
<style>
  body {
    font-family: sans-serif;
    background: #0f1724;
    color: #e6eef6;
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
    margin: 0;
  }

  .wrap {
    width: 100%;
    background: #0b1220;
    border-radius: 12px;
    display: grid;
    grid-template-columns: 300px 1fr;
    overflow: hidden;
    height: 100%;
  }

  .panel {
    padding: 20px;
    background: #121b2e;
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .chat-area {
    display: flex;
    flex-direction: column;
    height: 100%;
    overflow: hidden;
  }

  .chat-header {
    padding: 15px;
    border-bottom: 1px solid #1b2435;
    flex-shrink: 0;
    display: grid;
    grid-template-areas:
    "header content";
  }

  /* ✅ The key fix */
  .messages {
    flex: 1;
    overflow-y: auto;
    padding: 15px;
    display: flex;
    flex-direction: column;
    gap: 8px;
    min-height: 0; /* allows flexbox scrolling */
  }

  .msg {
    padding: 8px 12px;
    border-radius: 10px;
    background: rgba(255, 255, 255, 0.05);
    word-break: break-word;
  }

  .msg.me {
    background: rgba(45, 212, 191, 0.1);
  }

  .compose {
    padding: 10px;
    border-top: 1px solid #1b2435;
    display: flex;
    gap: 8px;
    flex-shrink: 0;
    background: #0b1220;
  }

  .compose input {
    flex: 1;
    padding: 8px;
    border-radius: 8px;
    border: none;
    background: #1b2435;
    color: #e6eef6;
  }

  .btn {
    padding: 8px 12px;
    border: none;
    border-radius: 8px;
    background: linear-gradient(90deg, #2dd4bf, #60a5fa);
    color: #05202a;
    cursor: pointer;
  }

  .btn:hover {
    opacity: 0.9;
  }
  
  .pop {
    display: none; /* Hidden by default */
    position: fixed; /* Stay in place */
    z-index: 1; /* Sit on top */
    padding-top: 200px; /* Location of the box */
    left: 0;
    top: 0;
    width: 100%; /* Full width */
    height: 100%; /* Full height */
    overflow: auto; /* Enable scroll if needed */
    background-color: rgb(0,0,0); /* Fallback color */
    background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
    border-radius: 50px;
  }
  
  .pop-content {
    position: relative;
    background-color: #f5f5f5;
    margin: auto;
    border: 2px solid #888;
    padding-bottom: 20px;
    border-radius: 50px;
    width: 50%;
    color: #28282e;
    box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2),0 6px 20px 0 rgba(0,0,0,0.19);
    -webkit-animation-name: animatetop;
    -webkit-animation-duration: 0.4s;
    animation-name: animatetop;
    animation-duration: 0.4s;
    text-align: center; 
  }
  
  .close {
    position: absolute;
    color: #000;
    top: 15px;    /* distance from the top edge of the modal */
  	right: 15px;
    font-size: 28px;
    font-weight: bold;
  }

  .close:hover,
  .close:focus {
    color: #d1cfcf;
    text-decoration: none;
    cursor: pointer;
  }
  
  #header {
  	grid-area: header;
  }
  
  #rightInfo {
  	text-align: right;
    grid-area: content; 
    align-self: center;
}
</style>


<!-- Firebase SDK v11.10.0 -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

</head>
<body>

<div class="wrap">
  <aside class="panel">
    <h2 id="Instruct">Enter your username</h2>
    <input type="text" id="usernameInput" placeholder="Username..." style="display: none;">
    <input type="text" id="passwordInput" placeholder="Password..." style="display: none;">
    <button id="loginBtn" class="btn" style="display: none;">Login</button>
    <div id="userView" style="display: block; margin-top: 20px;">
      <div id="currentUser">Sam (@sam)</div>
      <button id="logoutBtn" class="btn" style="margin-top:10px;">Log out</button>
    </div>
  </aside>
  <div id="myPop" class="pop" style="display: none;">
  	<div class="pop-content">
    <span class="close">×</span>
    <h2>Update Password</h2>
    <input type="text" id="currPass" placeholder="Current password" size="40" style="height:30px;">
    <br>
    <br>
    <input type="text" id="newPass" placeholder="New password" size="40" style="height:30px;">
    <br>
    <br>
    <button class="btn" id="changePassBtn2">Set Password</button>
    </div>
  </div>
  <main class="chat-area">
    <div class="chat-header">
      <div id="header">
      <h3>CompSci Chat</h3>
      <div id="headerUser">Sam @sam</div>
      </div>
      <div id="rightInfo" style="display: none;">Not logged In</div>
    </div>
    <div class="messages" id="messages"></div>
    <div class="compose">
      <input type="text" id="msgInput" placeholder="Sign in to send">
      <button id="sendBtn" class="btn">Send</button>
    </div>
  </main>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {

  // -----------------------------
  // Firebase Configuration
  // -----------------------------
  const firebaseConfig = {
    apiKey: "AIzaSyA9-gMEniY_sXFO6jMiZYgoYnAxPhu5oEc",
    authDomain: "chat-581be.firebaseapp.com",
    databaseURL: "https://chat-581be-default-rtdb.firebaseio.com",
    projectId: "chat-581be",
    storageBucket: "chat-581be.appspot.com",
    messagingSenderId: "873296181303",
    appId: "1:873296181303:web:a9c0d1bbbd17e0074f27b2"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // -----------------------------
  // Approved users (names + handles)
  // -----------------------------
  const approvedUsers = {
    "Samuel": "@19195",
    "Jack": "@18976",
    "Isaac": "@19051",
    "Freddie": "@19070",
    "Sean": "@19050",
    "Rhodri": "@19191",
    "Otis": "@19135",
    "Oscar": "@19185",
    "Rowan": "@19095",
    "Nathan": "@19190",
    "Jacob": "@19000",
    "Ben": "@19043"
  };

  // UI elements
  const usernameInput = document.getElementById('usernameInput');
  const passwordInput = document.getElementById('passwordInput');
  const loginBtn = document.getElementById('loginBtn');
  const logoutBtn = document.getElementById('logoutBtn');
  const currentUserEl = document.getElementById('currentUser');
  const currentUserRight = document.getElementById('rightInfo');
  const headerUser = document.getElementById('headerUser');
  const Instruct = document.getElementById('Instruct');
  const msgInput = document.getElementById('msgInput');
  const sendBtn = document.getElementById('sendBtn');
  const messagesEl = document.getElementById('messages');
  const userView = document.getElementById('userView');

  let currentUser = null;

  // -----------------------------
  // Initialize all users with default password "password1"
  // -----------------------------
  db.ref('users').once('value').then(snapshot => {
    if (!snapshot.exists()) {
      const userSetup = {};
      for (const name in approvedUsers) {
        userSetup[name] = {
          handle: approvedUsers[name],
          password: "password3"
        };
      }
      db.ref('users').set(userSetup);
      console.log("Initialized users with default passwords.");
    }
  });

  // -----------------------------
  // Login
  // -----------------------------
  loginBtn.addEventListener('click', async () => {
    const name = usernameInput.value.trim();
    const pass = passwordInput.value.trim();

    if (!name) return alert("Enter your first name.");
    if (!approvedUsers[name]) return alert("You are not on the approved user list!");

    const userRef = db.ref('users/' + name);
    const snapshot = await userRef.once('value');

    if (!snapshot.exists()) {
      alert("User not found in database.");
      return;
    }

    const userData = snapshot.val();

    if (pass !== userData.password) {
      alert(`Why is Diddyblud trying to log into ${name}'s account`);
      return;
    }

    currentUser = { name, handle: approvedUsers[name] };
    localStorage.setItem('chat_user', JSON.stringify(currentUser));
    updateUI();
  });

  // -----------------------------
  // Logout
  // -----------------------------
  logoutBtn.addEventListener('click', () => {
    currentUser = null;
    localStorage.removeItem('chat_user');
    updateUI();
  });

  // -----------------------------
  // Update UI
  // -----------------------------
  function updateUI() {
    const stored = localStorage.getItem('chat_user');
    currentUser = stored ? JSON.parse(stored) : null;

    if (currentUser) {
      usernameInput.style.display = 'none';
      passwordInput.style.display = 'none';
      loginBtn.style.display = 'none';
      userView.style.display = 'block';
      currentUserRight.style.display = 'block';
      currentUserEl.innerHTML = `
        ${currentUser.name} (${currentUser.handle})
      `;
      currentUserRight.innerHTML = `
        <button class="btn" id="changePassBtn">Change Password</button>
      `;
      headerUser.textContent = `${currentUser.name} ${currentUser.handle}`;
      Instruct.textContent = `Hello ${currentUser.name}`;
      msgInput.disabled = false;
      sendBtn.disabled = false;

      // Add listener for password change
      document.getElementById('changePassBtn').addEventListener('click', changePassword);

    } else {
      usernameInput.style.display = 'block';
      passwordInput.style.display = 'block';
      currentUserRight.style.display = 'none';
      loginBtn.style.display = 'inline-block';
      userView.style.display = 'none';
      headerUser.textContent = 'Not signed in';
      Instruct.textContent = `Enter your username`;
      msgInput.disabled = true;
      sendBtn.disabled = true;
    }

    // Refresh messages
    db.ref('messages').once('value').then(snapshot => {
      messagesEl.innerHTML = '';
      snapshot.forEach(child => renderMessage(child.val()));
    });
  }

  // -----------------------------
  // Change password
  // -----------------------------
  
  function changePassword() {
    const pop = document.getElementById("myPop");
    pop.style.display = "block";
  }
  
  function changePassword2() {
    const newPass = document.getElementById('newPass').value.trim();
    if (!newPass) return alert("Enter a new password!");
    db.ref('users/' + currentUser.name + '/password').set(newPass)
      .then(() => alert("Password changed successfully!"))
      .catch(err => console.error(err));
  }
  
  var span = document.getElementsByClassName("close")[0];

  // When the user clicks on <span> (x), close the modal
  span.onclick = function() { 
  	const pop = document.getElementById("myPop");
    pop.style.display = "none";
  }
  // -----------------------------
  // Messaging
  // -----------------------------
  function sendMessage() {
    const text = msgInput.value.trim();
    if (!text || !currentUser) return;
    const msg = {
      userName: currentUser.name,
      userHandle: currentUser.handle,
      text,
      time: new Date().toISOString()
    };
    db.ref('messages').push(msg);
    msgInput.value = '';
  }

  sendBtn.addEventListener('click', sendMessage);
  msgInput.addEventListener('keydown', e => {
    if (e.key === 'Enter') sendMessage();
  });

  function renderMessage(msg) {
    const div = document.createElement('div');
    const isMe = currentUser && currentUser.handle === msg.userHandle;
    div.className = 'msg' + (isMe ? ' me' : '');
    const time = new Date(msg.time).toLocaleTimeString();
    div.innerHTML = `<strong>${msg.userName} ${msg.userHandle}</strong><br>${msg.text}<br><small style="color:#9aa6bd">${time}</small>`;
    messagesEl.appendChild(div);
    messagesEl.scrollTop = messagesEl.scrollHeight;
  }

  // -----------------------------
  // Listen to messages live
  // -----------------------------
  db.ref('messages').on('child_added', snapshot => {
    renderMessage(snapshot.val());
  });

  // -----------------------------
  // Initialize UI
  // -----------------------------
  updateUI();
});
</script>
</body></html>
