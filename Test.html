<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CompSci Chat</title>
<style>
/* Keep your original styles */
body {font-family:sans-serif;background:#0f1724;color:#e6eef6;display:flex;justify-content:center;align-items:center;height:100vh;margin:0;}
.wrap{width:100%;background:#0b1220;border-radius:12px;display:grid;grid-template-columns:300px 1fr;overflow:hidden;height:100%;}
.panel{padding:20px;background:#121b2e;display:flex;flex-direction:column;gap:10px;}
.chat-area{display:flex;flex-direction:column;height:100%;overflow:hidden;}
.chat-header{padding:15px;border-bottom:1px solid #1b2435;flex-shrink:0;display:grid;grid-template-areas:"header content";}
.messages{flex:1;overflow-y:auto;padding:15px;display:flex;flex-direction:column;gap:8px;min-height:0;}
.msg{padding:8px 12px;border-radius:10px;background:rgba(255,255,255,0.05);word-break:break-word;}
.msg.me{background:rgba(45,212,191,0.1);}
.compose{padding:10px;border-top:1px solid #1b2435;display:flex;gap:8px;flex-shrink:0;background:#0b1220;}
.compose input{flex:1;padding:8px;border-radius:8px;border:none;background:#1b2435;color:#e6eef6;}
.btn{padding:8px 12px;border:none;border-radius:8px;background:linear-gradient(90deg,#2dd4bf,#60a5fa);color:#05202a;cursor:pointer;}
.btn:hover{opacity:0.9;}
.pop{display:none;position:fixed;z-index:1000;padding-top:120px;left:0;top:0;width:100%;height:100%;overflow:auto;background-color:rgba(0,0,0,0.4);}
.pop-content{position:relative;background:#f5f5f5;margin:auto;border:2px solid #888;padding:20px;border-radius:20px;width:400px;color:#28282e;box-shadow:0 4px 8px rgba(0,0,0,0.2);text-align:center;}
.close{position:absolute;color:#000;top:12px;right:12px;font-size:24px;font-weight:bold;cursor:pointer;}
.close:hover{color:#d1cfcf;}
</style>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
</head>
<body>
<div class="wrap">
  <aside class="panel">
    <h2 id="Instruct">Sign Up / Login</h2>
    <input type="text" id="usernameInput" placeholder="Username...">
    <input type="password" id="passwordInput" placeholder="Password...">
    <button id="loginBtn" class="btn">Login</button>
    <button id="signupBtn" class="btn">Sign Up</button>
    <div id="userView" style="display:none;margin-top:20px;">
      <div id="currentUser"></div>
      <button id="logoutBtn" class="btn" style="margin-top:10px;">Log out</button>
    </div>
  </aside>

  <div id="myPop" class="pop">
    <div class="pop-content">
      <span class="close" id="closePop">×</span>
      <h2>Change Password</h2><br>
      <input type="password" id="currPass" placeholder="Current password" style="width:90%;height:34px;"><br>		<br>
      <input type="password" id="newPass" placeholder="New password" style="width:90%;height:34px;"><br><br>
      <button class="btn" id="changePassBtn2">Set Password</button>
    </div>
  </div>

  <div id="myPop2" class="pop">
    <div class="pop-content">
      <span class="close" id="closePop2">×</span>
      <h2>Create Account</h2><br>
      <input type="text" id="username1" placeholder="Enter a username" style="width:90%;height:30px;" maxlength="18"><br><br>
      <input type="password" id="password1" placeholder="Enter a password" style="width:90%;height:30px;"><br><br>
      <input type="number" id="num1" placeholder="Enter school ID" style="width:90%;height:30px;"><br><br>
      <button class="btn" id="signupBtn2">Sign Up</button>
    </div>
  </div>

  <main class="chat-area">
    <div class="chat-header">
      <div id="header">
        <h3>CompSci Chat</h3>
        <div id="headerUser"></div>
      </div>
      <div id="rightInfo" style="display:none;">Not logged in</div>
    </div>

    <div class="messages" id="messages"></div>

    <div class="compose">
      <input type="text" id="msgInput" placeholder="Sign in to send" disabled>
      <button id="sendBtn" class="btn" disabled>Send</button>
    </div>
  </main>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const firebaseConfig = {
    apiKey: "AIzaSyA9-gMEniY_sXFO6jMiZYgoYnAxPhu5oEc",
    authDomain: "chat-581be.firebaseapp.com",
    databaseURL: "https://chat-581be-default-rtdb.firebaseio.com",
    projectId: "chat-581be",
    storageBucket: "chat-581be.appspot.com",
    messagingSenderId: "873296181303",
    appId: "1:873296181303:web:a9c0d1bbbd17e0074f27b2"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  const approvedUsers = {
    "Samuel": "19195@churchill-academy.org",
    "Jack": "18976@churchill-academy.org",
    "Isaac": "19051@churchill-academy.org",
    "Freddie": "19070@churchill-academy.org",
    "Sean": "19050@churchill-academy.org",
    "Rhodri": "19191@churchill-academy.org",
    "Otis": "19135@churchill-academy.org",
    "Oscar": "19185@churchill-academy.org",
    "Rowan": "19095@churchill-academy.org",
    "Nathan": "19190@churchill-academy.org",
    "Jacob": "19000@churchill-academy.org",
    "Ben": "19043@churchill-academy.org",
    "Doug": "18972@churchill-academy.org"
  };

  // Elements
  const usernameInput = document.getElementById('usernameInput');
  const passwordInput = document.getElementById('passwordInput');
  const loginBtn = document.getElementById('loginBtn');
  const signupBtn = document.getElementById('signupBtn');
  const logoutBtn = document.getElementById('logoutBtn');
  const currentUserEl = document.getElementById('currentUser');
  const headerUser = document.getElementById('headerUser');
  const Instruct = document.getElementById('Instruct');
  const msgInput = document.getElementById('msgInput');
  const sendBtn = document.getElementById('sendBtn');
  const messagesEl = document.getElementById('messages');
  const userView = document.getElementById('userView');

  const myPop2 = document.getElementById('myPop2');
  const closePop2 = document.getElementById('closePop2');
  const username1 = document.getElementById('username1');
  const password1 = document.getElementById('password1');
  const num1 = document.getElementById('num1');
  const signupBtn2 = document.getElementById('signupBtn2');

  const myPop = document.getElementById('myPop');
  const closePop = document.getElementById('closePop');
  const currPass = document.getElementById('currPass');
  const newPass = document.getElementById('newPass');
  const changePassBtn2 = document.getElementById('changePassBtn2');

  let currentUser = null;

  // -------------------
  // Open/close modals
  // -------------------
  signupBtn.addEventListener('click', () => { myPop2.style.display = "block"; });
  closePop2.addEventListener('click', () => { myPop2.style.display = "none"; });
  closePop.addEventListener('click', () => { myPop.style.display = "none"; });

  function openChangePassword() {
    currPass.value = '';
    newPass.value = '';
    myPop.style.display = 'block';
  }

  // -------------------
  // Sign-up logic
  // -------------------
  signupBtn2.addEventListener('click', async () => {
    const u = username1.value.trim();
    const p = password1.value.trim();
    const n = num1.value.trim();
    if (!u || !p || !n) return alert("Fill all fields");

    const email = n.toLowerCase() + "@churchill-academy.org";

    try {
      await firebase.auth().createUserWithEmailAndPassword(email, p);
      const user = firebase.auth().currentUser;
      await db.ref('users/' + user.uid).set({ name: u, handle: email });
      currentUser = { uid: user.uid, name: u, handle: email };
      localStorage.setItem('chat_user', JSON.stringify(currentUser));
      myPop2.style.display = "none";
      updateUI();
    } catch (err) {
      alert(err.message);
    }
  });

  // -------------------
  // Login logic
  // -------------------
  loginBtn.addEventListener('click', async () => {
    const name = usernameInput.value.trim();
    const pass = passwordInput.value.trim();
    if (!name || !pass) return alert("Enter your username and password");

    const email = approvedUsers[name];
    if (!email) return alert("You are not on the approved user list!");

    try {
      await firebase.auth().signInWithEmailAndPassword(email, pass);
    } catch (err) {
      if (err.code === 'auth/user-not-found') {
        // Auto-create account
        await firebase.auth().createUserWithEmailAndPassword(email, pass);
        const user = firebase.auth().currentUser;
        await db.ref('users/' + user.uid).set({ name, handle: email });
      } else if (err.code === 'auth/wrong-password') {
        return alert(`Why is diddyblud trying to log into ${name}'s account`);
      } else {
        return alert(err.message);
      }
    }

    const user = firebase.auth().currentUser;
    currentUser = { uid: user.uid, name, handle: email };
    localStorage.setItem('chat_user', JSON.stringify(currentUser));
    updateUI();
  });

  // -------------------
  // Logout
  // -------------------
  logoutBtn.addEventListener('click', async () => {
    await firebase.auth().signOut();
    currentUser = null;
    localStorage.removeItem('chat_user');
    updateUI();
  });

  // -------------------
  // Change Password logic
  // -------------------
  changePassBtn2.addEventListener('click', async () => {
    const curr = currPass.value.trim();
    const neu = newPass.value.trim();
    if (!curr || !neu) return alert("Please fill both fields");

    try {
      const user = firebase.auth().currentUser;
      if (!user) return alert("You must be logged in to change your password");

      const cred = firebase.auth.EmailAuthProvider.credential(currentUser.handle, curr);
      await user.reauthenticateWithCredential(cred);
      await user.updatePassword(neu);
      alert("Password changed successfully!");
      myPop.style.display = 'none';
    } catch (err) {
      alert("Error: " + (err.message || err));
      console.error(err);
    }
  });

  // -------------------
  // UI update
  // -------------------
  function updateUI() {
    const stored = localStorage.getItem('chat_user');
    currentUser = stored ? JSON.parse(stored) : null;

    if (currentUser) {
      usernameInput.style.display = 'none';
      passwordInput.style.display = 'none';
      signupBtn.style.display = 'none';
      loginBtn.style.display = 'none';
      userView.style.display = 'block';
      currentUserEl.textContent = `${currentUser.name} (${currentUser.handle})`;
      headerUser.textContent = `${currentUser.name} ${currentUser.handle}`;
      Instruct.textContent = `Hello ${currentUser.name}`;
      msgInput.disabled = false;
      sendBtn.disabled = false;

      // Add change password button
      const right = document.getElementById('rightInfo');
      right.style.display = 'block';
      right.innerHTML = `<button class="btn" id="changePassBtn">Change Password</button>`;
      document.getElementById('changePassBtn').onclick = openChangePassword;

    } else {
      usernameInput.style.display = 'block';
      passwordInput.style.display = 'block';
      signupBtn.style.display = 'inline-block';
      loginBtn.style.display = 'inline-block';
      userView.style.display = 'none';
      headerUser.textContent = 'Not signed in';
      Instruct.textContent = 'Enter your username';
      msgInput.disabled = true;
      sendBtn.disabled = true;
      document.getElementById('rightInfo').style.display = 'none';
    }

    loadMessages();
  }

  // -------------------
  // Messaging
  // -------------------
  function renderMessage(msg) {
    if (!msg) return;
    const div = document.createElement('div');
    const isMe = currentUser && currentUser.handle === msg.userHandle;
    div.className = 'msg' + (isMe ? ' me' : '');
    const time = msg.time ? new Date(msg.time).toLocaleTimeString() : '';
    div.innerHTML = `<strong>${msg.userName} ${msg.userHandle}</strong><br>${msg.text}<br><small style="color:#9aa6bd">${time}</small>`;
    messagesEl.appendChild(div);
    messagesEl.scrollTop = messagesEl.scrollHeight;
  }

  async function loadMessages() {
    try {
      const snapshot = await db.ref('messages').once('value');
      messagesEl.innerHTML = '';
      snapshot.forEach(child => renderMessage(child.val()));
    } catch (err) {
      console.error(err);
    }
  }

  sendBtn.addEventListener('click', () => {
    const text = msgInput.value.trim();
    if (!text || !currentUser) return;
    db.ref('messages').push({
      userName: currentUser.name,
      userHandle: currentUser.handle,
      text,
      time: new Date().toISOString()
    });
    msgInput.value = '';
  });

  msgInput.addEventListener('keydown', e => { if (e.key === 'Enter') sendBtn.click(); });
  db.ref('messages').on('child_added', snapshot => renderMessage(snapshot.val()));

  // Firebase auth persistence
  firebase.auth().onAuthStateChanged(user => {
    if (user) {
      const snap = db.ref('users/' + user.uid);
      snap.once('value').then(profileSnap => {
        const profile = profileSnap.exists() ? profileSnap.val() : { name: user.email.split('@')[0], handle: user.email };
        currentUser = { uid: user.uid, name: profile.name, handle: profile.handle };
        localStorage.setItem('chat_user', JSON.stringify(currentUser));
        updateUI();
      });
    } else {
      localStorage.removeItem('chat_user');
      currentUser = null;
      updateUI();
    }
  });

  updateUI();
});
</script>

</body>
</html>
